name: Deploy Notification to n8n

# Trigger quando há push para a branch master (produção)
on:
  push:
    branches:
      - master
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - '.gitignore'

jobs:
  notify-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 2
      
      - name: Get commit info
        id: commit-info
        run: |
          COMMIT_MESSAGE=$(git log -1 --pretty=%B)
          COMMIT_AUTHOR=$(git log -1 --pretty=%an)
          COMMIT_HASH=$(git log -1 --pretty=%h)
          COMMIT_DATE=$(git log -1 --pretty=%ci)
          
          echo "message<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMIT_MESSAGE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "author=$COMMIT_AUTHOR" >> $GITHUB_OUTPUT
          echo "hash=$COMMIT_HASH" >> $GITHUB_OUTPUT
          echo "date=$COMMIT_DATE" >> $GITHUB_OUTPUT
      
      - name: Send webhook to n8n
        run: |
          curl -X POST "${{ secrets.N8N_DEPLOY_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "event": "deploy",
              "data": {
                "repository": "${{ github.repository }}",
                "branch": "${{ github.ref_name }}",
                "commit": {
                  "hash": "${{ steps.commit-info.outputs.hash }}",
                  "message": "${{ steps.commit-info.outputs.message }}",
                  "author": "${{ steps.commit-info.outputs.author }}",
                  "date": "${{ steps.commit-info.outputs.date }}"
                },
                "pusher": "${{ github.actor }}",
                "workflow": "${{ github.workflow }}",
                "runId": "${{ github.run_id }}",
                "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
              },
              "timestamp": "${{ github.event.head_commit.timestamp || github.event.repository.updated_at }}"
            }'
        continue-on-error: true
